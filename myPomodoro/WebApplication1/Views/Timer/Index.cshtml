@{
    ViewData["Title"] = "Timer";
}

<!-- Bootstrap CSS -->
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />

<!-- Optional: Font Awesome for star icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

<div class="modal fade show d-block" tabindex="-1" role="dialog"
     style="background-color: rgba(0,0,0,0.8);" aria-modal="true">
    <div class="modal-dialog modal-fullscreen" role="document">
        <div class="modal-content text-center" style="background-color: #f7f7f7;">

            <!-- [1] Modal Header -->
            <div class="modal-header">
                <h1 class="modal-title w-100" style="font-size: 2rem;">Pomodoro-Style Timer</h1>
            </div>

            <!-- [2] Modal Body -->
            <div class="modal-body" style="height: 75vh;">
                <div class="row w-100">

                    <!-- TOP: Normal Work vs. SOS Buttons -->
                    <div class="col-12 mb-3">
                        <div class="d-flex justify-content-center gap-2">
                            <!-- Normal Work Session Button -->
                            <button id="normalWorkBtn" class="btn btn-success">Work Session</button>
                            <!-- SOS Button -->
                            <button id="sosBtn" class="btn btn-danger">SOS</button>
                        </div>
                    </div>

                </div> <!-- row -->

                <div class="row w-100 h-100">
                    <!-- Left Column (Timer) -->
                    <div class="col-md-8 d-flex flex-column align-items-center justify-content-center">
                        <!-- Timer Display -->
                        <div id="timer-display" style="font-size: 5rem; margin-bottom: 1rem;">00:00</div>
                        <!-- Session Label (Work / Break) -->
                        <div id="session-label" style="font-size: 1.25rem; margin-bottom: 1rem;"></div>

                        <!-- Controls for session durations -->
                        <div class="mb-3">
                            <label for="workDuration" class="form-label">Work Session (minutes):</label>
                            <input type="number" id="workDuration" class="form-control"
                                   style="width:200px; margin: 0 auto;" value="30" />
                        </div>
                        <div class="mb-3">
                            <label for="restDuration" class="form-label">Rest Session (minutes):</label>
                            <input type="number" id="restDuration" class="form-control"
                                   style="width:200px; margin: 0 auto;" value="5" />
                        </div>

                        <!-- Category Toggle (dropdown) for "Job" or "Personal" -->
                        <div class="mb-3">
                            <label for="taskCategory" class="form-label">Select Task Category:</label>
                            <select id="taskCategory" class="form-select" style="width:200px; margin:0 auto;">
                                <option value="">-- Choose One --</option>
                                <option value="Job">Job</option>
                                <option value="Personal">Personal</option>
                            </select>
                        </div>

                        <!-- Buttons -->
                        <div class="d-flex flex-row gap-3">
                            <button id="start-btn" class="btn btn-success btn-lg" disabled>Start</button>
                            <button id="pause-btn" class="btn btn-warning btn-lg">Pause</button>
                            <button id="stop-and-record-btn" class="btn btn-info btn-lg">Stop &amp; Record</button>
                            <button id="reset-btn" class="btn btn-danger btn-lg">Reset</button>
                            <button id="record-btn" class="btn btn-primary btn-lg">Record</button>
                        </div>

                        <!-- Completed 30-min sessions -->
                        <div class="mt-4">
                            <span style="font-size: 1.5rem;">30-min Sessions Completed:</span>
                            <span id="completed-sessions" style="font-size: 2rem;">0</span>
                        </div>
                    </div>

                    <!-- Right Column (Focus Metrics) -->
                    <div class="col-md-4 d-flex align-items-center">
                        <div class="card w-100">
                            <div class="card-body">
                                <h5 class="card-title">Focus Metrics</h5>

                                <p>
                                    <strong>Today's Improvement:</strong>
                                    <span id="improvement-percentage" style="font-size: 1.25rem;">+0%</span>
                                </p>

                                <p>
                                    <strong>Today's Job Volume (min):</strong>
                                    <span id="today-job-volume" style="font-size: 1.25rem;">0</span>
                                </p>
                                <p>
                                    <strong>Last Work Day's Job Volume (min):</strong>
                                    <span id="prev-job-volume" style="font-size: 1.25rem;">0</span>
                                </p>

                                <p>
                                    <strong>Today's Personal Volume (min):</strong>
                                    <span id="today-personal-volume" style="font-size: 1.25rem;">0</span>
                                </p>
                                <p>
                                    <strong>Last Work Day's Personal Volume (min):</strong>
                                    <span id="prev-personal-volume" style="font-size: 1.25rem;">0</span>
                                </p>

                                <p>
                                    <strong>Focus Rating:</strong>
                                    <span id="self-intensity" style="font-size: 1.25rem;">N/A</span>
                                </p>

                                <!-- 5 Star Rating -->
                                <div id="starRating" style="margin-bottom: 1rem;">
                                    <i class="fa-solid fa-star" data-value="1"></i>
                                    <i class="fa-solid fa-star" data-value="2"></i>
                                    <i class="fa-solid fa-star" data-value="3"></i>
                                    <i class="fa-solid fa-star" data-value="4"></i>
                                    <i class="fa-solid fa-star" data-value="5"></i>
                                </div>
                                <button id="saveRatingBtn" class="btn btn-secondary btn-sm">Save Rating</button>
                            </div>
                        </div>
                    </div>

                </div> <!-- row -->
            </div>
            <!-- Modal Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        onclick="window.location.href='/'">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- The Jiu Jitsu Scenario Popup (optional if you want the SOS flow) -->
<div id="jiuJitsuModal" style="position: fixed; top: 20%; left: 50%; transform: translateX(-50%);
     width: 400px; z-index: 9999; background-color: white; border: 2px solid #444; border-radius: 8px;
     padding: 1rem; display: none;">
    <h3>Jiu Jitsu Scenario</h3>
    <div id="jjPosition" style="font-weight: bold;"></div>
    <div id="jjMove" style="margin-top: 0.5rem; font-style: italic;"></div>
    <div id="jjType" style="margin-top: 0.5rem;"></div>
    <div id="jjDesc" style="margin-top: 1rem;"></div>
    <button id="jjOkBtn" class="btn btn-primary" style="margin-top: 1rem;">OK</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="~/js/JiuJitsuScenarios.js"></script>

<script>
    // ==================== GLOBAL STATE (End-Time Approach) ====================
    let timerInterval = null;
    let isPaused = false;
    let isWorkSession = true;
    let workDuration = 30;
    let restDuration = 5;
    let thirtyMinSessionCount = 0;

    // For end-time logic
    let endTime = 0;         // the Date.now() + sessionMs
    let timeRemaining = 0;   // leftover ms when paused

    let sessionLogs = [];
    let pendingFocusRating = 0;
    let selectedCategory = "";

    // references
    const sessionLabelEl = document.getElementById("session-label");
    const taskCategoryEl = document.getElementById("taskCategory");
    const startBtn = document.getElementById("start-btn");
    const pauseBtn = document.getElementById("pause-btn");
    const stopRecordBtn = document.getElementById("stop-and-record-btn");
    const resetBtn = document.getElementById("reset-btn");
    const recordBtn = document.getElementById("record-btn");
    const saveRatingBtn = document.getElementById("saveRatingBtn");
    const stars = document.querySelectorAll("#starRating i");

    const normalWorkBtn = document.getElementById("normalWorkBtn");
    const sosBtn = document.getElementById("sosBtn");

    const jiuJitsuModal = document.getElementById("jiuJitsuModal");
    const jjPosition = document.getElementById("jjPosition");
    const jjMove = document.getElementById("jjMove");
    const jjType = document.getElementById("jjType");
    const jjDesc = document.getElementById("jjDesc");
    const jjOkBtn = document.getElementById("jjOkBtn");

    // On page load
    updateSessionLabel();
    fetchVolumeIncrease();
    checkCategorySelected();

    // ===================== EVENT LISTENERS =====================
    taskCategoryEl.addEventListener("change", () => {
        selectedCategory = taskCategoryEl.value;
        checkCategorySelected();
    });

    startBtn.addEventListener("click", startTimer);
    pauseBtn.addEventListener("click", pauseTimer);
    stopRecordBtn.addEventListener("click", stopAndRecord);
    resetBtn.addEventListener("click", resetTimer);
    recordBtn.addEventListener("click", () => recordSessions(false));
    saveRatingBtn.addEventListener("click", saveFocusRating);

    stars.forEach(star => {
        star.addEventListener("click", () => {
            const val = parseInt(star.getAttribute("data-value"));
            pendingFocusRating = val;
            updateStarDisplay(val);
        });
    });

    normalWorkBtn.addEventListener("click", () => {
        isWorkSession = true;
        pendingFocusRating = 0;
        updateStarDisplay(0);
        updateSessionLabel();
    });

    // Jiu Jitsu scenario for SOS
    sosBtn.addEventListener("click", showJiuJitsuScenario);
    jjOkBtn.addEventListener("click", () => {
        jiuJitsuModal.style.display = "none";
        startSOS();
    });

    // ================ Real-Time Approach ================

    // (A) Normal Start Timer
    function startTimer() {
        // If paused, unpause
        if (isPaused) {
            isPaused = false;
            // new endTime = now + leftover
            endTime = Date.now() + timeRemaining;
            startInterval();
            return;
        }

        // Otherwise, we are starting fresh
        workDuration = parseInt(document.getElementById("workDuration").value) || 30;
        restDuration = parseInt(document.getElementById("restDuration").value) || 5;

        if (timerInterval) clearInterval(timerInterval);

        // If it's a work session
        if (isWorkSession) {
            let ms = workDuration * 60 * 1000;
            endTime = Date.now() + ms;
        } else {
            let ms = restDuration * 60 * 1000;
            endTime = Date.now() + ms;
        }

        startInterval();
    }

    // (B) Start the setInterval that checks the difference
    function startInterval() {
        timerInterval = setInterval(() => {
            if (!isPaused) {
                let diff = endTime - Date.now();
                if (diff <= 0) {
                    // time's up
                    clearInterval(timerInterval);
                    diff = 0;

                    // log the finished session
                    const minutes = isWorkSession
                        ? parseInt(document.getElementById("workDuration").value)
                        : parseInt(document.getElementById("restDuration").value);
                    logSession(isWorkSession, minutes, pendingFocusRating);

                    // If it was a 30-min work session
                    if (isWorkSession && minutes === 30) {
                        thirtyMinSessionCount++;
                        document.getElementById("completed-sessions").innerText = thirtyMinSessionCount;
                    }

                    // If it was a work session, do record
                    if (isWorkSession) {
                        recordSessions(true);
                    }

                    // switch session type
                    isWorkSession = !isWorkSession;
                    pendingFocusRating = 0;
                    updateStarDisplay(0);
                    updateSessionLabel();

                    // auto-start next session
                    startTimer();
                } else {
                    // still time left
                    updateDisplay(diff);
                }
            }
        }, 250); // quarter-second updates are fine
    }

    function pauseTimer() {
        if (!timerInterval) return;
        isPaused = true;
        let diff = endTime - Date.now();
        if (diff < 0) diff = 0;
        timeRemaining = diff;
        clearInterval(timerInterval);
        timerInterval = null;
    }

    // ================ STOP & RECORD: End Work Early ================
    function stopAndRecord() {
        if (!isWorkSession || !timerInterval) {
            alert("Stop & Record only applies during a Work session in progress.");
            return;
        }
        clearInterval(timerInterval);
        timerInterval = null;

        let diff = endTime - Date.now();
        if (diff < 0) diff = 0;
        // how many ms have we actually used?
        let totalMs = (parseInt(document.getElementById("workDuration").value) || 30) * 60 * 1000;
        let usedMs = totalMs - diff;
        if (usedMs < 0) usedMs = 0;
        let usedMin = Math.round(usedMs / 60000);

        logSession(true, usedMin, pendingFocusRating);

        // if it was a 30-min session
        if (parseInt(document.getElementById("workDuration").value) === 30) {
            thirtyMinSessionCount++;
            document.getElementById("completed-sessions").innerText = thirtyMinSessionCount;
        }

        recordSessions(true);

        // reset to zero
        endTime = 0;
        timeRemaining = 0;
        isPaused = false;
        isWorkSession = true;
        updateDisplay(0);
        updateStarDisplay(0);
        updateSessionLabel();
    }

    // (C) SOS approach: always 5 min
    function showJiuJitsuScenario() {
        if (!jiuJitsuScenarios || jiuJitsuScenarios.length === 0) {
            alert("No Jiu Jitsu scenarios found. Please add more!");
            startSOS();
            return;
        }
        const randIndex = Math.floor(Math.random() * jiuJitsuScenarios.length);
        const scenario = jiuJitsuScenarios[randIndex];
        jjPosition.textContent = `Position: ${scenario.position}`;
        jjMove.textContent = `Move: ${scenario.move}`;
        jjType.textContent = `Type: ${scenario.type}`;
        jjDesc.textContent = scenario.description;
        jiuJitsuModal.style.display = "block";
    }

    function startSOS() {
        // 5-min work session
        isWorkSession = true;
        isPaused = false;
        pendingFocusRating = 0;
        selectedCategory = "SOS";

        // Clear old interval if any
        if (timerInterval) clearInterval(timerInterval);

        const ms = 5 * 60 * 1000;
        endTime = Date.now() + ms;
        startInterval();
        updateSessionLabel();
    }

    // ================ updateDisplay: show mm:ss from ms ================
    function updateDisplay(ms) {
        if (ms < 0) ms = 0;
        let totalSec = Math.floor(ms / 1000);
        let min = Math.floor(totalSec / 60);
        let sec = totalSec % 60;

        let minStr = (min < 10 ? "0" : "") + min;
        let secStr = (sec < 10 ? "0" : "") + sec;
        document.getElementById("timer-display").textContent = `${minStr}:${secStr}`;
    }

    // Reset Timer entirely
    function resetTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = null;
        endTime = 0;
        timeRemaining = 0;
        isPaused = false;
        isWorkSession = true;
        updateDisplay(0);
        pendingFocusRating = 0;
        updateStarDisplay(0);
        updateSessionLabel();
    }

    // update session label, etc.
    function updateSessionLabel() {
        if (isWorkSession && selectedCategory !== "SOS") {
            selectedCategory = taskCategoryEl.value;
        }
        sessionLabelEl.textContent = isWorkSession ? "Work Session" : "Break Session";
        checkCategorySelected();
    }

    function checkCategorySelected() {
        if (isWorkSession && selectedCategory !== "SOS" && !selectedCategory) {
            startBtn.disabled = true;
        } else {
            startBtn.disabled = false;
        }
    }

    // log the session
    function logSession(isWork, duration, focusRating) {
        const endTimeStamp = new Date();
        const msDuration = duration * 60_000;
        const startTimeStamp = new Date(endTimeStamp - msDuration);

        let cat = (isWork) ? selectedCategory : "";
        sessionLogs.push({
            startTime: startTimeStamp.toISOString(),
            endTime: endTimeStamp.toISOString(),
            durationMinutes: duration,
            sessionType: isWork ? "Work" : "Rest",
            focusRating: focusRating,
            sessionCategory: cat
        });

        if (isWork && focusRating > 0) {
            document.getElementById("self-intensity").textContent = `${focusRating} / 5`;
        }
    }

    // record to CSV
    async function recordSessions(isAuto) {
        if (sessionLogs.length === 0) {
            if (!isAuto) alert("No sessions to record.");
            return;
        }
        try {
            const response = await fetch("/Timer/RecordSession", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(sessionLogs)
            });
            if (response.ok) {
                if (!isAuto) {
                    alert("Sessions recorded successfully (Email sent if configured).");
                }
                sessionLogs = [];
                await fetchVolumeIncrease();
            } else {
                const err = await response.text();
                if (!isAuto) {
                    alert("Error recording sessions: " + err);
                }
            }
        } catch (error) {
            if (!isAuto) {
                alert("Error sending request: " + error);
            }
        }
    }

    function saveFocusRating() {
        if (pendingFocusRating > 0) {
            document.getElementById("self-intensity").textContent =
                `${pendingFocusRating} / 5 (pending)`;
            alert("Focus rating saved for the next Work session.");
        }
    }

    function updateStarDisplay(rating) {
        stars.forEach(star => {
            let val = parseInt(star.getAttribute("data-value"));
            star.style.color = (val <= rating) ? "gold" : "gray";
        });
    }

    // fetch improvement stats
    async function fetchVolumeIncrease() {
        try {
            const resp = await fetch("/Timer/GetDailyImprovement");
            if (!resp.ok) return;
            const data = await resp.json();

            document.getElementById("improvement-percentage").textContent =
                `${data.improvementPercent.toFixed(1)}%`;

            document.getElementById("today-job-volume").textContent =
                data.todayJobVolume;
            document.getElementById("prev-job-volume").textContent =
                data.previousDayJobVolume;
            document.getElementById("today-personal-volume").textContent =
                data.todayPersonalVolume;
            document.getElementById("prev-personal-volume").textContent =
                data.previousDayPersonalVolume;

        } catch (err) {
            console.error("Failed to fetch daily improvement:", err);
        }
    }
</script>
