@{
    ViewData["Title"] = "Timer";
}

<!-- Bootstrap CSS -->
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />

<!-- Optional: Font Awesome for star icons (for 5-star rating) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

<div class="modal fade show d-block" tabindex="-1" role="dialog"
     style="background-color: rgba(0,0,0,0.8);" aria-modal="true">
    <div class="modal-dialog modal-fullscreen" role="document">
        <div class="modal-content text-center" style="background-color: #f7f7f7;">

            <!-- [1] Modal Header -->
            <div class="modal-header">
                <h1 class="modal-title w-100" style="font-size: 2rem;">Pomodoro-Style Timer</h1>
            </div> <!-- [1] end .modal-header -->
            <!-- [2] Modal Body -->
            <div class="modal-body" style="height: 75vh;">
                <!-- [3] Bootstrap Row for layout -->
                <div class="row w-100 h-100">

                    <!-- [4] Left/Center Column (col-md-8) -->
                    <div class="col-md-8 d-flex flex-column align-items-center justify-content-center">

                        <!-- Timer Display -->
                        <div id="timer-display" style="font-size: 5rem; margin-bottom: 1rem;">00:00</div>

                        <!-- Session Label (Work / Break) -->
                        <div id="session-label" style="font-size: 1.25rem; margin-bottom: 1rem;">
                            <!-- Dynamically shows "Work Session" or "Break Session" -->
                        </div>

                        <!-- Controls for session durations -->
                        <div class="mb-3">
                            <label for="workDuration" class="form-label">Work Session (minutes):</label>
                            <input type="number" id="workDuration" class="form-control"
                                   style="width:200px; margin: 0 auto;" value="30" />
                        </div>
                        <div class="mb-3">
                            <label for="restDuration" class="form-label">Rest Session (minutes):</label>
                            <input type="number" id="restDuration" class="form-control"
                                   style="width:200px; margin: 0 auto;" value="5" />
                        </div>

                        <!-- NEW: Category Toggle (dropdown) for "Job" or "Personal" -->
                        <div class="mb-3">
                            <label for="taskCategory" class="form-label">Select Task Category:</label>
                            <select id="taskCategory" class="form-select" style="width:200px; margin:0 auto;">
                                <option value="">-- Choose One --</option>
                                <option value="Job">Job</option>
                                <option value="Personal">Personal</option>
                            </select>
                        </div>

                        <!-- Buttons -->
                        <div class="d-flex flex-row gap-3">
                            <button id="start-btn" class="btn btn-success btn-lg" disabled>Start</button>
                            <button id="pause-btn" class="btn btn-warning btn-lg">Pause</button>
                            <button id="stop-and-record-btn" class="btn btn-info btn-lg">Stop &amp; Record</button>
                            <button id="reset-btn" class="btn btn-danger btn-lg">Reset</button>
                            <button id="record-btn" class="btn btn-primary btn-lg">Record</button>
                        </div>

                        <!-- Completed 30-min sessions -->
                        <div class="mt-4">
                            <span style="font-size: 1.5rem;">30-min Sessions Completed:</span>
                            <span id="completed-sessions" style="font-size: 2rem;">0</span>
                        </div>

                    </div> <!-- [4] end col-md-8 -->
                    <!-- [5] Right Column (col-md-4) for Focus Metrics Card -->
                    <div class="col-md-4 d-flex align-items-center">
                        <div class="card w-100">
                            <div class="card-body">
                                <h5 class="card-title">Focus Metrics</h5>
                                <p>
                                    <strong>Today's Improvement:</strong>
                                    <span id="improvement-percentage" style="font-size: 1.25rem;">+0%</span>
                                </p>

                                <p>
                                    <strong>Focus Rating:</strong>
                                    <span id="self-intensity" style="font-size: 1.25rem;">N/A</span>
                                </p>

                                <!-- 5 Star Rating (clickable icons) -->
                                <div id="starRating" style="margin-bottom: 1rem;">
                                    <i class="fa-solid fa-star" data-value="1"></i>
                                    <i class="fa-solid fa-star" data-value="2"></i>
                                    <i class="fa-solid fa-star" data-value="3"></i>
                                    <i class="fa-solid fa-star" data-value="4"></i>
                                    <i class="fa-solid fa-star" data-value="5"></i>
                                </div>

                                <!-- A button to save the star rating for the next session -->
                                <button id="saveRatingBtn" class="btn btn-secondary btn-sm">Save Rating</button>

                            </div> <!-- end .card-body -->
                        </div> <!-- end .card -->
                    </div> <!-- [5] end col-md-4 -->

                </div> <!-- [3] end .row w-100 h-100 -->
            </div> <!-- [2] end .modal-body -->
            <!-- [6] Modal Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        onclick="window.location.href='/'">
                    Close
                </button>
            </div> <!-- [6] end .modal-footer -->

        </div> <!-- end .modal-content -->
    </div> <!-- end .modal-dialog -->
</div> <!-- end .modal.fade -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let timerInterval = null;
    let totalSeconds = 0;
    let isPaused = false;

    // We begin with a "Work" session
    let isWorkSession = true;
    let workDuration = 30;
    let restDuration = 5;

    // For tracking 30-min sessions completed
    let thirtyMinSessionCount = 0;

    // We store completed session logs in memory
    let sessionLogs = [];

    // Keep a "pendingFocusRating" for the star rating selected
    let pendingFocusRating = 0;

    // Category for the "Work" session: "Job" or "Personal" (empty by default)
    let selectedCategory = "";

    // Grab references
    const sessionLabelEl = document.getElementById("session-label");
    const taskCategoryEl = document.getElementById("taskCategory");
    const startBtn = document.getElementById("start-btn");
    const pauseBtn = document.getElementById("pause-btn");
    const stopRecordBtn = document.getElementById("stop-and-record-btn");
    const resetBtn = document.getElementById("reset-btn");
    const recordBtn = document.getElementById("record-btn");
    const saveRatingBtn = document.getElementById("saveRatingBtn");

    const stars = document.querySelectorAll("#starRating i");

    // On page load
    updateSessionLabel();  // Show "Work Session" or "Break Session"
    fetchVolumeIncrease(); // Get today's improvement at startup
    checkCategorySelected(); // initial check

    // === Event Listeners ===
    taskCategoryEl.addEventListener("change", () => {
        selectedCategory = taskCategoryEl.value;
        checkCategorySelected();
    });

    startBtn.addEventListener("click", startTimer);
    pauseBtn.addEventListener("click", pauseTimer);
    stopRecordBtn.addEventListener("click", stopAndRecord);
    resetBtn.addEventListener("click", resetTimer);
    recordBtn.addEventListener("click", () => recordSessions(false));
    saveRatingBtn.addEventListener("click", saveFocusRating);

    // Star click events
    stars.forEach(star => {
        star.addEventListener("click", () => {
            const val = parseInt(star.getAttribute("data-value"));
            pendingFocusRating = val;
            updateStarDisplay(val);
        });
    });

    // ==========================
    //   TIMER CORE LOGIC
    // ==========================
    function startTimer() {
        // if paused, just resume
        if (isPaused) {
            isPaused = false;
            return;
        }

        // Otherwise, we start fresh
        workDuration = parseInt(document.getElementById("workDuration").value);
        restDuration = parseInt(document.getElementById("restDuration").value);

        // Clear any existing interval
        if (timerInterval) {
            clearInterval(timerInterval);
        }

        totalSeconds = (isWorkSession ? workDuration : restDuration) * 60;
        updateDisplay(totalSeconds);

        timerInterval = setInterval(() => {
            if (!isPaused) {
                totalSeconds--;
                updateDisplay(totalSeconds);

                if (totalSeconds <= 0) {
                    clearInterval(timerInterval);

                    // We finished this session
                    logSession(isWorkSession, (isWorkSession ? workDuration : restDuration), pendingFocusRating);

                    // If it was a 30-min work session, increment the completed counter
                    if (isWorkSession && workDuration === 30) {
                        thirtyMinSessionCount++;
                        document.getElementById("completed-sessions").innerText = thirtyMinSessionCount;
                    }

                    // If we just ended a work session => auto-start rest
                    // If we just ended a rest => user must press Start again
                    if (isWorkSession) {
                        // 1) Attempt an auto-record to get real-time improvement
                        recordSessions(true);

                        // 2) Switch to rest
                        isWorkSession = false;
                        pendingFocusRating = 0;
                        updateStarDisplay(0);
                        updateSessionLabel();

                        // 3) Immediately start rest
                        startTimer();
                    } else {
                        // We ended a rest session => revert to work session
                        isWorkSession = true;
                        pendingFocusRating = 0;
                        updateStarDisplay(0);
                        updateSessionLabel();
                    }
                }
            }
        }, 1000);
    }

    function pauseTimer() {
        isPaused = true;
    }

    /**
     * "Stop & Record" => stops the current Work session early,
     * logs how long you actually worked, records it, then resets timer for next session.
     */
    function stopAndRecord() {
        // Only relevant if we are in a Work session and timer is running
        if (!isWorkSession || !timerInterval) {
            alert("Stop & Record only applies during a Work session in progress.");
            return;
        }

        // 1) Clear the interval
        clearInterval(timerInterval);
        timerInterval = null;

        // 2) Calculate how many minutes we actually spent
        // totalSeconds was the time left. So "elapsed" = (initial minutes * 60) - totalSeconds
        let fullWorkSeconds = workDuration * 60;
        let elapsedSeconds = fullWorkSeconds - totalSeconds;
        let elapsedMinutes = elapsedSeconds / 60;

        // Convert to nearest integer or do partial decimals
        let actualDuration = Math.round(elapsedMinutes);  // or keep a decimal if you prefer

        // 3) logSession with that partial duration
        logSession(true, actualDuration, pendingFocusRating);

        // If it was a 30-min session originally
        if (workDuration === 30) {
            thirtyMinSessionCount++;
            document.getElementById("completed-sessions").innerText = thirtyMinSessionCount;
        }

        // Now we do a record call so we update real-time improvement
        recordSessions(true);

        // 4) We remain in the same mode (Work?), or switch to rest?
        // Per your use-case, let's remain in "Work mode" but 0 timer
        // user can choose to do a rest or start again
        totalSeconds = 0;
        updateDisplay(totalSeconds);
        isPaused = false;   // not paused, just stopped
        isWorkSession = true;
        pendingFocusRating = 0;
        updateStarDisplay(0);
        updateSessionLabel();

        // 5) The user can choose "Start" if they want a new session, or "Reset" etc.
    }

    function resetTimer() {
        clearInterval(timerInterval);
        timerInterval = null;
        totalSeconds = 0;
        isPaused = false;
        isWorkSession = true; // reset to work
        updateDisplay(totalSeconds);
        pendingFocusRating = 0;
        updateStarDisplay(0);
        updateSessionLabel();
    }

    // ==========================
    //   LOGGING & RECORDING
    // ==========================
    function logSession(isWork, duration, focusRating) {
        const endTime = new Date();
        const msDuration = duration * 60000;
        const startTime = new Date(endTime - msDuration);

        // We'll store the "SessionCategory" only if it's "Work"
        // Because a Rest session won't have "Job"/"Personal"?
        // Adjust logic if you want categories for rest too.
        let category = "";
        if (isWork) {
            category = selectedCategory;
        }

        sessionLogs.push({
            startTime: startTime.toISOString(),
            endTime: endTime.toISOString(),
            durationMinutes: duration,
            sessionType: isWork ? "Work" : "Rest",
            focusRating: focusRating,
            sessionCategory: category
        });

        // If it's a work session and there's a rating, display it
        if (isWork && focusRating > 0) {
            document.getElementById("self-intensity").textContent = `${focusRating} / 5`;
        }
    }

    async function recordSessions(isAuto) {
        if (sessionLogs.length === 0) {
            if (!isAuto) alert("No sessions to record.");
            return;
        }

        try {
            const response = await fetch("/Timer/RecordSession", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(sessionLogs)
            });

            if (response.ok) {
                if (!isAuto) {
                    alert("Sessions recorded successfully. Email sent if configured.");
                }

                // Clear logs
                sessionLogs = [];

                // Update daily improvement in real-time
                await fetchVolumeIncrease();

            } else {
                const err = await response.text();
                if (!isAuto) {
                    alert("Error recording sessions: " + err);
                }
            }
        } catch (error) {
            if (!isAuto) {
                alert("Error sending request to server: " + error);
            }
        }
    }

    // ==========================
    //   CATEGORY & RATING
    // ==========================
    function saveFocusRating() {
        if (pendingFocusRating > 0) {
            document.getElementById("self-intensity").textContent = `${pendingFocusRating} / 5 (pending)`;
            alert("Focus rating saved for next Work session.");
        }
    }

    function updateStarDisplay(rating) {
        stars.forEach(star => {
            let val = parseInt(star.getAttribute("data-value"));
            star.style.color = (val <= rating) ? "gold" : "gray";
        });
    }

    function checkCategorySelected() {
        // Only enable the Start button if:
        // 1) We are in a Work session
        // 2) A category is chosen (Job or Personal)
        // If it's a Break session, user can always start it.
        // Adjust logic if you'd prefer to require category for break as well.
        if (isWorkSession && !selectedCategory) {
            startBtn.disabled = true;
        } else {
            startBtn.disabled = false;
        }
    }

    // ==========================
    //   UTILS
    // ==========================
    function updateSessionLabel() {
        sessionLabelEl.textContent = isWorkSession ? "Work Session" : "Break Session";
        checkCategorySelected();
    }

    async function fetchVolumeIncrease() {
        try {
            const resp = await fetch("/Timer/GetDailyImprovement");
            if (!resp.ok) return;
            const data = await resp.json();
            document.getElementById("improvement-percentage").textContent =
                `${data.improvementPercent.toFixed(1)}%`;
        } catch (err) {
            console.error("Failed to fetch daily improvement:", err);
        }
    }
</script>
